<!DOCTYPE html>
<html lang="{% if lang %}{{ lang }}{% else %}en-GB{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {# --- START: Define actualTranslationsMap & Hreflang --- #}
    {# Attempt to get the clean map from translations.default #}
    {% set actualTranslationsMap = translations %}
    {# If translations.default was empty or not structured as expected, 
       you could try translations.module.exports as an alternative here, 
       but let's test with .default first based on the dump output.
    #}
    {# {% set actualTranslationsMap = translations.module.exports %} #}


    {% if translationKey and lang and actualTranslationsMap and actualTranslationsMap[translationKey] %}
        <link rel="alternate" hreflang="{{ lang }}" href="{{ page.url | url }}" />
        {% for langCode, langUrl in actualTranslationsMap[translationKey] %}
            {% if langCode != lang %}
                <link rel="alternate" hreflang="{{ langCode }}" href="{{ langUrl | url }}" />
            {% endif %}
        {% endfor %}
        {% set defaultLang = 'en-GB' %}
        {% if actualTranslationsMap[translationKey][defaultLang] %}
             <link rel="alternate" hreflang="x-default" href="{{ actualTranslationsMap[translationKey][defaultLang] | url }}" />
        {% elif actualTranslationsMap[translationKey]['en-GB'] %}
            <link rel="alternate" hreflang="x-default" href="{{ actualTranslationsMap[translationKey]['en-GB'] | url }}" />
        {% endif %}
    {% endif %}
    {# --- END: Define actualTranslationsMap & Hreflang --- #}

    <title>{% if title %}{{ title }}{% else %}BrahmaVidya Publishing{% endif %}</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=inter:300,400,500,700&display=swap" rel="stylesheet" />
    <style>
      html { 
        scroll-behavior: smooth; 
        -webkit-text-size-adjust: 100%; 
      }
    </style>
</head>
<body>

    {# --- START: Main Yellow Debug Box --- #}
    <p style="background:yellow; color:black; padding:10px; border:1px solid red; font-size:12px; line-height:1.4; z-index: 10000; position: relative;">
        <strong>BASE.NJK DEBUG:</strong><br>
        Full 'translations' object: <pre style="white-space: pre-wrap; word-break: break-all;">{{ translations | dump(2) | safe }}</pre><br>
        Trying 'translations.default': <pre style="white-space: pre-wrap; word-break: break-all;">{{ translations.default | dump(2) | safe }}</pre><br>
        Value of 'actualTranslationsMap': <pre style="white-space: pre-wrap; word-break: break-all;">{{ actualTranslationsMap | dump(2) | safe }}</pre><br>
        Page 'lang': [{{ lang }}]<br>
        Page 'translationKey': [{{ translationKey }}]<br>
        Page 'page.url': [{{ page.url }}]
    </p>
    {# --- END: Main Yellow Debug Box --- #}

    <header class="site-header">
        <div class="container">
            <a href="{{ '/' | url }}" class="logo-link">
                <img src="/img/9ae3510c78b10dfe4d9df080479a46e5.jpeg" alt="BrahmaVidya Publishing Logo" class="logo-image">
            </a>
            <nav class="language-switcher">
             {% if not hideSwitcher %} {# Allows hiding switcher on specific pages like thank-you.md #}
                {# Ensure actualTranslationsMap is defined and has the key before proceeding #}
                {% if translationKey and lang and actualTranslationsMap and actualTranslationsMap[translationKey] %}
                    {% set availableLangs = {'en-GB': 'English', 'pl': 'Polski'} %}
                    {% set linksOutput = [] %}

                    {% for langCode, langName in availableLangs %}
                        {% if actualTranslationsMap[translationKey][langCode] %}
                            {% if langCode == lang %}
                                {% set linkHtmlString = '<span class="current-lang" aria-current="page">' ~ langName ~ '</span>' %}
                            {% else %}
                                {% set linkUrl = actualTranslationsMap[translationKey][langCode] | url %}
                                {% set linkHtmlString = '<a href="' ~ linkUrl ~ '" lang="' ~ langCode ~ '" hreflang="' ~ langCode ~ '" class="lang-link">' ~ langName ~ '</a>' %}
                            {% endif %}
                            {% set linksOutput = linksOutput.concat([linkHtmlString]) %}
                        {% endif %}
                    {% endfor %}
                    {{ linksOutput | join('<span class="lang-separator"> | </span>') | safe }}
                {% else %}
                    <!-- Switcher Data Problem: translationKey, lang, or actualTranslationsMap[translationKey] is missing/false -->
                    <!-- To debug this, check the yellow box values for lang, translationKey, and actualTranslationsMap -->
                {% endif %}
             {% endif %}
            </nav>
        </div>
    </header>

    <main>
        {{ content | safe }}
    </main>

    <footer class="site-footer-bottom">
        <div class="container">
            {% if lang == 'pl' %}
                <p>
                    © {{ site.currentYear }} BrahmaVidya Publishing. Wszelkie prawa zastrzeżone.
                    <span class="footer-separator">|</span>
                    <a href="/pl/#contact-form-area" class="footer-contact-link">Kontakt</a>
                </p>
            {% elif lang == 'en-GB' %}
                 <p>
                    © {{ site.currentYear }} BrahmaVidya Publishing. All rights reserved.
                    <span class="footer-separator">|</span>
                    <a href="/en/#contact-form-area" class="footer-contact-link">Contact</a>
                </p>
            {% else %}
                 <p>
                    © {{ site.currentYear }} BrahmaVidya Publishing. All rights reserved.
                    <span class="footer-separator">|</span>
                    <a href="/#contact-form-area" class="footer-contact-link">Contact</a>
                </p>
            {% endif %}
        </div>
    </footer>
</body>
</html>